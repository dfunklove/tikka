<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="lib/autocomplete/autocomplete.min.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script type="text/javascript" src="https://playground.abysscorp.org/chartjs/livecharts/dist/Chart.min.js"></script>
    <script type="text/javascript" src="lib/autocomplete/autocomplete.min.js"></script>
    <script type="text/javascript" src="lib/fuse.js"></script>
    <script type="text/javascript" src="js/chart.js?v=1"></script>
  </head>
  <body>
    <div style="display:block">
      <label for="symbol">Symbol:</label>
      <!--input type="text" id="symbol" list="symbol_list"-->
      <input type="text" id="symbol"> <button id="go">GO</button>
      <datalist id="symbol_list"></datalist>
    </div>
    <canvas id="chart0" style="width:70%;height:70%;display:block"></canvas>
    <script>
      var fuse
      var socket
      var subscription
    
      function setupWebsocket() {
        socket = new WebSocket('wss://'+window.location.hostname+'/tikka/app');
      
        // Connection opened -> Subscribe
        socket.addEventListener('open', function (event) {
            console.log("connection opened")
            //socket.send(JSON.stringify({'type':'subscribe', 'symbol': 'AAPL'}))
            //socket.send(JSON.stringify({'type':'subscribe', 'symbol': 'BINANCE:BTCUSDT'}))
            //socket.send(JSON.stringify({'type':'subscribe', 'symbol': 'IC MARKETS:1'}))
        });
        
        // Listen for messages
        socket.addEventListener('message', function (event) {
            console.log('Message from server ', event.data);
            let mydata = JSON.parse(event.data)
            if (mydata['type'] == 'trade') {
              let symbol = mydata['data'][0]['s']
              let price = mydata['data'][0]['p']
              console.log(`symbol: ${symbol}, price: ${price}`)

              addValue(price)
            }
        });
      }

      function subscribe(symbol) {
          console.log("subscribe: "+symbol)
          socket.send(JSON.stringify({'type':'subscribe','symbol': symbol}))
      }

      function unsubscribe(symbol) {
          console.log("unsubscribe: "+symbol)
          socket.send(JSON.stringify({'type':'unsubscribe','symbol': symbol}))
      }

      function updateSubscription(e) {
        if (subscription)
          unsubscribe(subscription)
        try {
          resetChart()
        } catch(err) {
          console.log(err)
        }
        subscription = document.getElementById("symbol").value
        subscribe(subscription)
      }

      setupWebsocket()

      fetch('symbol_list.json')
        .then(response => response.json())
        .then(response => { 
          fuse = new Fuse(response, {threshold: "0", ignoreLocation: "true", keys: ["value", "text"]})
          autocomplete({
            input: document.getElementById("symbol"),
            fetch: function(text, update) {
              var result = fuse.search(text)
              console.log(result)
              for (var key in result) {
                  result[key] = result[key].item;
                  result[key].label = result[key].text
                }
              update(result);
            },
            onSelect: function(item) {
              this.input.value = item.value;
            }
          });
        })

      document.getElementById("go").addEventListener('click', updateSubscription)

      
</script>
  </body>
</html>
